{% import 'utils.jinja' as utils %}

CREATE TABLE quality__count_c_resource_count_{{ src|lower }}_{{ period|lower }} AS (
{%- set cat_field = category %}
WITH
{{ utils.extract_status(src, 'src_status') }},

{%- if systems %}
-- Flatten categories of the provided system and recombine the codes as a list
{{ utils.extract_codes(src, cat_field, systems, 'extracted_codes', is_array=true) }},

-- Left join back to src to catch rows without a proper system category
grouped_category_src AS (
    SELECT src.*, extracted_codes.codes AS grouped_categories
    FROM {{ src|lower }} AS src
    LEFT JOIN extracted_codes
    ON src.id = extracted_codes.id
),
{%- set src = 'grouped_category_src' %}
{%- set cat_field = 'grouped_categories' %}
{%- endif %}

simplified AS (
    SELECT
        src.id,

        -- Convert array of categories into one string, separated by semicolon
        {%- if category %}
        COALESCE(
            ARRAY_JOIN(
                ARRAY_SORT(
                    {{ cat_field }}
                ), '; '
            ),
            'missing-or-null'
        ) AS {{ category }},
        {%- endif %}

        -- Parse string datetime into a single period string
        {%- if dates %}
        COALESCE(
            SUBSTR(
                CAST(date_trunc('{{ period }}', date(from_iso8601_timestamp(
                    COALESCE(
                        {{ dates|join(', ') }}
                    )
                ))) AS VARCHAR),
                1,
                {% if period == 'year' %} 4 {% else %} 7 {% endif %}
            ),
            'missing-or-null'
        ) AS {{ period }},
        {%- endif %}

        COALESCE(
            src_status.status,
            'missing-or-null'
        ) AS status
    FROM {{ src|lower }} AS src
    LEFT JOIN src_status
    ON src.id = src_status.id
)

SELECT
    COUNT(DISTINCT id) AS cnt,

    {%- if category %}
    {{ category }},
    {%- endif %}

    {%- if dates %}
    {{ period }},
    {%- endif %}

    status
FROM simplified
GROUP BY CUBE(
    {%- if category %}
    {{ category }},
    {%- endif %}

    {%- if dates %}
    {{ period }},
    {%- endif %}

    status
)
);