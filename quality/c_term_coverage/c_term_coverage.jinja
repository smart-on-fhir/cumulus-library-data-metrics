{% import 'utils.jinja' as utils %}

CREATE TABLE quality__count_c_term_coverage_{{ src|lower }}_{{ field|lower }} AS (

WITH
src_status AS {{ utils.extract_status(src) }},

{% if category_system %}
src_categories AS {{ utils.extract_codes(src, 'category', system=category_system, is_array=true) }},
{% endif %}

src_systems_flat AS (
    SELECT
        id,

    {% if is_coding %} -- a single Coding field
        {{ field }}.system
    FROM {{ src }}

    {% elif is_array %} -- array of CodeableConcepts
        c.coding.system
    FROM {{ src }},
        UNNEST({{ field }}) AS cc (cc_row),
        UNNEST(cc.cc_row.coding) AS c (coding)

    {% else %} -- default is a single CodeableConcept
        c.coding.system
    FROM {{ src }},
        UNNEST({{ field }}.coding) AS c (coding)
    {% endif %}
),
src_systems_readable AS (
    SELECT
        id,
        (
            CASE
            WHEN system = 'http://loinc.org'
            THEN 'LOINC'
            WHEN system = 'http://snomed.info/sct'
            THEN 'SNOMED'
            WHEN system = 'http://www.nlm.nih.gov/research/umls/rxnorm'
            THEN 'RxNorm'
            ELSE system
            END
        ) AS system
    FROM src_systems_flat
),
src_systems AS (
    SELECT
        id,
        ARRAY_AGG(system) AS systems
    FROM src_systems_readable
    GROUP BY id
),

simplified AS (
    SELECT
        src.id,

        {% if dates %}
        {{ utils.get_date(dates, 'year') }} AS "year",
        {% endif %}

        {% if category_system %}
        {{ utils.array_to_string('src_categories.codes') }} AS category,
        {% endif %}

        {{ utils.array_to_string('src_systems.systems') }} AS systems,
        {{ utils.coalesce_missing('src_status.status') }} AS status

    FROM {{ src }} AS src

    LEFT JOIN src_status
    ON src.id = src_status.id

    {% if category_system %}
    LEFT JOIN src_categories
    ON src.id = src_categories.id
    {% endif %}

    LEFT JOIN src_systems
    ON src.id = src_systems.id
)


SELECT
    COUNT(DISTINCT id) AS cnt,

    {% if category_system %}
    category,
    {% endif %}

    systems,
    status

    {% if dates %}
    , "year"
    {% endif %}

FROM simplified
GROUP BY CUBE(
    {% if category_system %}
    category,
    {% endif %}

    systems,
    status

    {% if dates %}
    , "year"
    {% endif %}
)
);
