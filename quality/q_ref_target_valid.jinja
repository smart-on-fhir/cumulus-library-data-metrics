CREATE TABLE quality__q_ref_target_valid_{{ src|lower }}_{{ dest|lower }} AS (
{%- if is_array %}
WITH
    flattened AS (
        SELECT id, t.row AS unnested_field
        FROM {{ src|lower }},
            UNNEST({{ field }}) AS t (row)
    )
{%- set field = 'unnested_field' %}
{%- endif %}
SELECT
    src.id,
    src.{{ field }} AS target
{%- if is_array %}
FROM flattened AS src
{%- else %}
FROM {{ src|lower }} AS src
{%- endif %}
LEFT JOIN {{ dest|lower }} AS dest
ON SUBSTRING(src.{{ field }}.reference, LENGTH('{{ dest }}/') + 1) = dest.id
WHERE
    src.{{ field }}.reference LIKE '{{ dest }}/%'
    AND dest.id IS NULL
);