{% import 'utils.jinja' as utils %}

CREATE TABLE data_metrics__q_ref_target_valid_{{ src|lower }}_{{ dest|lower }} AS (

{% if field == 'context.encounter' and not schema['context']['encounter'] %}
    SELECT id FROM {{ src }} WHERE 1=0  -- return an empty table
{% else %}

WITH
src_status AS {{ utils.extract_status(src) }}

{%- if is_array %}
    , flattened AS (
        SELECT id, t.row AS unnested_field
        FROM {{ src }},
            UNNEST({{ field }}) AS t (row)
    )
{%- set src = 'flattened' %}
{%- set field = 'unnested_field' %}
{%- endif %}

SELECT
    src.id,
    src_status.status,
    src.{{ field }} AS target
FROM {{ src }} AS src
LEFT JOIN src_status
ON src.id = src_status.id
LEFT JOIN {{ dest }} AS dest
ON SUBSTRING(src.{{ field }}.reference, LENGTH('{{ dest }}/') + 1) = dest.id
WHERE
    src.{{ field }}.reference LIKE '{{ dest }}/%' -- keep in sync with denominator query
    AND dest.id IS NULL

{% endif %} -- closing initial "return empty table" check

);